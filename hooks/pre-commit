#!/bin/bash
# Code Markers Pre-commit Hook
# Enforces code marker standards for Mallow-Dev organization

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

# Check for critical markers that should block commits
CRITICAL_MARKERS=$(git diff --cached | grep -E "FIXME|BUG|SECURITY:critical" || true)

if [ -n "$CRITICAL_MARKERS" ]; then
    echo -e "${RED}❌ COMMIT BLOCKED${NC}"
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo "Found critical markers that must be resolved before commit:"
    echo ""
    echo "$CRITICAL_MARKERS" | head -10
    echo ""
    echo -e "${RED}Critical markers found:${NC}"
    echo "  • FIXME - Known issues that need fixing"
    echo "  • BUG - Confirmed bugs"
    echo "  • SECURITY:critical - Critical security vulnerabilities"
    echo ""
    echo "Fix these issues before committing, or use one of:"
    echo "  • HACK - Temporary workaround (if acceptable)"
    echo "  • TODO - For planned work"
    echo "  • LATER/FUTURE - For deferred work"
    echo ""
    echo "To bypass this check (not recommended):"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi

# Warn about high-priority security issues (non-blocking)
SECURITY_HIGH=$(git diff --cached | grep -E "SECURITY:high" || true)

if [ -n "$SECURITY_HIGH" ]; then
    echo -e "${YELLOW}⚠️  WARNING${NC}"
    echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo "Found high-priority security markers:"
    echo ""
    echo "$SECURITY_HIGH" | head -5
    echo ""
    echo -e "${YELLOW}Consider addressing before merge to development or main${NC}"
    echo ""
fi

# Summary of markers in this commit
echo "✅ Code marker check passed"
echo ""
echo "Markers in this commit:"
ALL_MARKERS=$(git diff --cached | grep -E "TODO|HACK|OPTIMIZE|REFACTOR|LATER|FUTURE|SECURITY:" || true)

if [ -n "$ALL_MARKERS" ]; then
    echo "$ALL_MARKERS" | grep -E "TODO" | wc -l | xargs -I {} echo "  • TODO: {}"
    echo "$ALL_MARKERS" | grep -E "HACK" | wc -l | xargs -I {} echo "  • HACK: {}"
    echo "$ALL_MARKERS" | grep -E "SECURITY:medium|SECURITY:low" | wc -l | xargs -I {} echo "  • SECURITY (med/low): {}"
    echo "$ALL_MARKERS" | grep -E "LATER|FUTURE" | wc -l | xargs -I {} echo "  • LATER/FUTURE: {}"
fi

exit 0
